<!DOCTYPE html>
<html lang="ru">

<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="Speak your mind">
  <title>Speak your mind</title>
  <link rel="icon" type="image/x-icon" href="./favicon.ico">
  <link rel="icon" type="image/png" sizes="32x32" href="./img/favicon/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="./img/favicon/favicon-16x16.png">
  <link rel="apple-touch-icon" sizes="180x180" href="./img/favicon/apple-touch-icon.png">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/swiper@10/swiper-bundle.min.css">
  <link rel="stylesheet" href="css/style.min.css">
</head>

<body>
  <div class="wrapper internal">
    <main>
      <section class="doctor-account">
        <div class="container">
          <div class="doctor-account__wrapper">
            <div class="doctor-account__left-col">
              <div class="doctor-account__nav">
                <div class="user-account__nav-logo">
                  <a href="doctor-account-sessions.html">
                    <img src="./img/svg/nav-logo.svg" width="72" height="72" alt="Speak your mind.">
                  </a>
                </div>
                <a href="doctor-account-sessions.html" class="doctor-account__nav-link">
                  <svg width="25" height="25" fill="currentColor">
                    <use xlink:href="./img/sprite.svg#nav-sessions"></use>
                  </svg>
                  <span data-translate="int_nav_sessions">Sessions</span>
                  <span class="requests-indicator"></span>
                </a>
                <a href="doctor-account-schedule.html" class="doctor-account__nav-link is-active">
                  <svg width="25" height="25" fill="currentColor">
                    <use xlink:href="./img/sprite.svg#nav-schedule"></use>
                  </svg>
                  <span data-translate="int_nav_schedule">Schedule</span>
                  <span class="requests-indicator"></span>
                </a>
                <a href="doctor-account-clients.html" class="doctor-account__nav-link">
                  <svg width="25" height="25" fill="currentColor">
                    <use xlink:href="./img/sprite.svg#nav-clients"></use>
                  </svg>
                  <span data-translate="int_nav_clients">Clients</span>
                </a>
                <a href="doctor-account-payments.html" class="doctor-account__nav-link">
                  <svg width="25" height="25" fill="currentColor">
                    <use xlink:href="./img/sprite.svg#nav-payment"></use>
                  </svg>
                  <span data-translate="int_nav_payments">Payments</span>
                </a>
                <a href="doctor-account-settings.html" class="doctor-account__nav-link">
                  <svg width="25" height="25" fill="currentColor">
                    <use xlink:href="./img/sprite.svg#nav-settings"></use>
                  </svg>
                  <span data-translate="int_nav_profile">Profile</span>
                </a>
                <div href="#" class="doctor-account__nav-link nav-lang-switcher js-dropdown-trigger"
                  data-id="#nav-lang-switcher">
                  <svg width="25" height="25" fill="currentColor">
                    <use xlink:href="./img/sprite.svg#nav-language"></use>
                  </svg>
                  <span class="current-language"></span>
                  <svg width="10" height="10" fill="currentColor">
                    <use xlink:href="./img/sprite.svg#dropdown"></use>
                  </svg>
                  </span>
                  <ul class="lang-switcher__list list-reset" id="nav-lang-switcher">
                    <!-- <li class="lang-switcher__item">
                    <a href="#" data-lang="hu">Hu</a>
                  </li> -->
                    <li class="lang-switcher__item">
                      <a href="#" data-lang="en">English</a>
                    </li>
                    <li class="lang-switcher__item">
                      <a href="#" data-lang="ru" data-translate="doc_q_language_ru">Русский</a>
                    </li>
                  </ul>
                </div>
                <a href="doctor-account-help.html" class="user-account__nav-link">
                  <svg width="25" height="25" fill="currentColor">
                    <use xlink:href="./img/sprite.svg#nav-help"></use>
                  </svg>
                  <span data-translate="int_nav_help">Help</span>
                </a>
                <a href="doctor-landing.html" class="user-account__nav-link logout-btn">
                  <svg width="25" height="25" fill="currentColor">
                    <use xlink:href="./img/sprite.svg#nav-logout"></use>
                  </svg>
                  <span data-translate="int_nav_logout">Logout</span>
                </a>
              </div>
            </div>
            <div class="doctor-account__right-col">
              <div class="doctor-account__schedule schedule">
                <div class="doctor-account__heading">
                  <h2 class="text-40" data-translate="doctor_schedule_title">Schedule</h2>
                  <p class="text-18 text-success schedule__text-success">
                    <span data-translate="schedule_text_success">Changes saved</span>
                  </p>
                  <p data-translate="doctor_schedule_text">Please check the box for the time when you are free and for
                    which consultations can be scheduled</p>
                  <button type="button" class="schedule__send-btn btn" id="send-btn">
                    <span class="icon-loader">
                      <svg width="32" height="32" fill="currentColor">
                        <use xlink:href="./img/sprite.svg#icon-loader"></use>
                      </svg>
                    </span>
                    <span data-translate="save_changes_btn">Save changes</span>
                  </button>
                </div>
                <div class="calendar-wrapper">
                  <button class="btn-current schedule__tab-btn is-active" id="btn-1"
                    data-translate="schedule_current_week">Сurrent week</button>
                  <button class="btn-2 schedule__tab-btn" id="btn-2"></button>
                  <button class="btn-3 schedule__tab-btn" id="btn-3"></button>
                  <button class="btn-4 schedule__tab-btn" id="btn-4"></button>
                  <div class="cal-wrapper">
                    <div id="divCal"></div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </section>
    </main>
    <footer class="footer">
      <div class="container">
        <div class="footer__left"></div>
        <div class="footer__copyright">
          <span>&copy; Speak Your Mind 2023</span>
          <a href="terms.html" class="text-green" data-translate="terms">Terms of Service</a>
          <span>Site developed by <a target="_blank" rel="nofollow noreferrer noopener" href="https://sleeps.co/" class="text-green">S-CATS</a></span>
        </div>
      </div>
    </footer>
  </div>

  <script>
    class Calendar {
      //Сохраняем идентификатор div
      divId;

      // Дни недели с понедельника
      DaysOfWeek = ['Пн', 'Вт', 'Ср', 'Чт', 'Пт', 'Сб', 'Вс'
      ];

      //Устанавливаем текущий месяц, год
      d = new Date();

      currMonth = this.d.getMonth('9');
      currYear = this.d.getFullYear('22');
      currDay = this.d.getDate('3');

      constructor(divId) {
        this.divId = divId;
      }

      // Показать текущий месяц/неделю
      showcurr() {
        this.showWeek(this.currYear, this.currMonth);
      };

      // Показать неделю
      showWeek(y, m, date = this.currDay) {

        let curr = new Date(y, m, date);

        let week = []

        //
        for (let i = 1; i <= 7; i++) {
          const currDay = curr.getDay() ? curr.getDay() : 7;
          let first = curr.getDate() - currDay + i + 1;
          let day = new Date(curr.setDate(first)).toISOString().slice(0, 10)
          week.push(day)
        }

        let html = '<table>';

        html += '<tr class="days">';
        html += '<td class="empty"></td>';
        for (let i = 0; i < week.length; i++) {
          const day = new Date(week[i])
          html += `<td class="date" x-time="${day}">${this.DaysOfWeek[i]},  ${day.getDate()}</td>`;
        }
        html += '</tr>';
        // добавлять checkbox и др
        for (let i = 0; i < 24; i++) {
          html += '<tr class="slots">'
          html += '<td class="hours">'
          if (i < 10) {
            html += `0${i}:00`;
          } else {
            html += `${i}:00`;
          }
          html += '</td>'
          for (let j = 0; j < 7; j++) {
            const tdDay = new Date(week[j]).getDate();
            const tdMonth = new Date(week[j]).getMonth() + 1;
            const tdyear = new Date(week[j]).getFullYear();
            html += '<td class="check">'
            html += `<label><input type="checkbox" value="`
            if (tdDay < 10) {
              html += `0${tdDay}-`
            } else {
              html += `${tdDay}-`
            }
            if (tdMonth < 10) {
              html += `0${tdMonth}-`
            } else {
              html += `${tdMonth}-`
            }
            html += `${tdyear}`
            html += ' ';
            if (i < 10) {
              html += `0${i}:00`;
            } else {
              html += `${i}:00`;
            }
            html += `" name="schedule"></label>`
            html += '</td>'
          }
          html += '</tr>'
        }

        // Конец таблицы
        html += '</table>';

        // Записываем HTML в div
        document.getElementById(this.divId).innerHTML = html;
      };

      showWeek2() {
        let nextDate = new Date(this.currYear, this.currMonth, this.currDay);
        nextDate.setDate(nextDate.getDate() + 7);

        this.showWeek(nextDate.getFullYear(), nextDate.getMonth(), nextDate.getDate());
      };

      showWeek3() {
        let nextDate = new Date(this.currYear, this.currMonth, this.currDay);
        nextDate.setDate(nextDate.getDate() + 14);

        this.showWeek(nextDate.getFullYear(), nextDate.getMonth(), nextDate.getDate());
      };

      showWeek4() {
        let nextDate = new Date(this.currYear, this.currMonth, this.currDay);
        nextDate.setDate(nextDate.getDate() + 21);

        this.showWeek(nextDate.getFullYear(), nextDate.getMonth(), nextDate.getDate());
      };
    }

    // функция для текста кнопок

    function getWeekRange(weekOffset) {
      const today = new Date();
      const dayOfWeek = today.getDay(); // Получаем день недели (0 - воскресенье, 1 - понедельник, ..., 6 - суббота)

      // Вычисляем разницу в днях до понедельника (1) и воскресенья (0)
      const mondayOffset = dayOfWeek === 0 ? -6 : 1 - dayOfWeek; // Если сегодня воскресенье, то -6, иначе 1 - dayOfWeek
      const sundayOffset = dayOfWeek === 0 ? 0 : 7 - dayOfWeek; // Если сегодня воскресенье, то 0, иначе 7 - dayOfWeek

      // Получаем даты понедельника и воскресенья текущей недели
      const monday = new Date(today);
      monday.setDate(today.getDate() + mondayOffset + (weekOffset * 7));

      const sunday = new Date(today);
      sunday.setDate(today.getDate() + sundayOffset + (weekOffset * 7));

      // Форматируем даты в нужный формат "DD.MM"
      const formatDate = (date) => {
        const day = String(date.getDate()).padStart(2, '0');
        const month = String(date.getMonth() + 1).padStart(2, '0'); // Месяцы начинаются с 0
        return `${day}.${month}`;
      };

      return `${formatDate(monday)} - ${formatDate(sunday)}`;
    }

    // Устанавливаем текст для кнопок

    function setButtons() {
      document.querySelector('#btn-2').textContent = getWeekRange(1);
      document.querySelector('#btn-3').textContent = getWeekRange(2);
      document.querySelector('#btn-4').textContent = getWeekRange(3);
    }

    function clearBtnClasses() {
      const btns = document.querySelectorAll('.schedule__tab-btn');

      btns.forEach((btn) => {
        if (btn.classList.contains('is-active')) {
          btn.classList.remove('is-active');
        }
      })
    }

    // получение расписания с бэкенда

    function loadDataFromBackend() {
      const token = localStorage.getItem('token');

      const dataToSend = JSON.stringify({
        session_token: token,
        schedule: [],
        timezone: ''
      });

      if (token) {
        // URL для получения данных пользователя
        const url = 'https://www.speakyourmind.help:8000/doctor_schedule';

        // Отправка запроса на сервер
        fetch(url, {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          },
          body: dataToSend
        })
          .then(response => {
            if (!response.ok) {
              throw new Error('Сеть не в порядке');
            }
            return response.json();
          })
          .then(data => {
            // Обновляем dataObject и localStorage на основе полученных данных
            if (data.schedule) {
              console.log('Расписание:', data);
              dataObject = data.schedule.map(slot => slot.date_time);
              saveDataToLocalStorage();
              restoreCheckboxState();
              setTimeout(() => {
                setAttributesForCheckedCheckboxes(data.schedule);
              }, 2000);
            }
          })
          .catch(error => {
            console.error('Ошибка при получении данных:', error);
          });
      } else {
        console.log('Токен не найден. Пожалуйста, войдите в систему.');
      }
    }

    function parseDateString(dateString) {
      const [datePart, timePart] = dateString.split(' ');
      const [day, month, year] = datePart.split('-').map(Number);
      const [hours, minutes] = timePart.split(':').map(Number);
      return new Date(year, month - 1, day, hours, minutes);
    }

    function markExpiredCheckboxes(inputs) {
      if (!inputs.length) {
        setTimeout(() => {
          markExpiredCheckboxes(inputs);
        }, 200);
        return;
      }

      const currentTime = new Date();

      inputs.forEach((checkbox) => {
        const checkboxTime = parseDateString(checkbox.value);

        // Проверяем, если время прошло
        if (checkboxTime < currentTime) {
          checkbox.closest('td').classList.add('expired');
        }

        // Проверяем, если только день прошел
        const checkboxDate = new Date(checkboxTime.getFullYear(), checkboxTime.getMonth(), checkboxTime.getDate());
        const currentDate = new Date(currentTime.getFullYear(), currentTime.getMonth(), currentTime.getDate());

        if (checkboxDate < currentDate) {
          checkbox.closest('td').classList.add('past');
        }
      });
    }

    function setAttributesForCheckedCheckboxes(schedule) {
      const inputs = document.querySelectorAll('input[type="checkbox"]');

      if (!inputs.length) {
        setTimeout(() => {
          setAttributesForCheckedCheckboxes(inputs);
        }, 200);
        return;
      }

      inputs.forEach((checkbox) => {
        const formattedTime = checkbox.value;

        // Найдите соответствующий объект в расписании
        const slot = schedule.find(item => item.date_time === formattedTime);

        // Если чекбокс отмечен и слот найден, устанавливаем атрибуты
        setTimeout(() => {
          if (checkbox.checked && slot) {
            checkbox.setAttribute('data-sh-id', slot.sh_id);
            checkbox.setAttribute('data-client-id', slot.client_id);
            checkbox.setAttribute('data-client-name', slot.client_name);
            if (slot.client_id !== null) {
              const label = checkbox.closest('label');
              const tooltip = document.createElement('span');
              tooltip.classList.add('tooltip');
              tooltip.setAttribute('data_id', slot.client_id);
              tooltip.setAttribute('data_name', slot.client_name);
              if (slot.accepted == 1) {
                tooltip.classList.add('accepted');
              } else if (slot.accepted === 0 && slot.pending_change === 0) {
                tooltip.classList.add('not-accepted');
              } else {
                tooltip.classList.add('pending');
              }
              label.append(tooltip);
              tooltip.addEventListener('mouseover', () => {
                tooltip.classList.add('is-hovered');
              });
              tooltip.addEventListener('mouseout', () => {
                tooltip.classList.remove('is-hovered');
              });
              label.addEventListener('click', (e) => {
                e.preventDefault();
              });
            }
          } else {
            // Если чекбокс не отмечен, можно удалить атрибуты (если нужно)
            checkbox.removeAttribute('data-sh-id');
            checkbox.removeAttribute('data-client-id');
            checkbox.removeAttribute('data-client-name');
          }
        }, 1000);
      });
    }

    function updateCal() {
      const inputs = document.querySelectorAll('input[type="checkbox"]');

      if (!inputs.length) {
        setTimeout(() => {
          updateCal();
        }, 500);
        return;
      }
      showValues();
      restoreCheckboxState();
      setButtons();
      markExpiredCheckboxes(inputs);
    }

    // сохраняем данные в массив
    let dataObject = [];

    // Проверяем, есть ли сохраненные данные в localStorage
    if (localStorage.getItem('checkboxData')) {
      const storedData = JSON.parse(localStorage.getItem('checkboxData'));
      if (Array.isArray(storedData)) {
        dataObject = storedData;
      }
    }

    function saveDataToLocalStorage() {
      localStorage.setItem('checkboxData', JSON.stringify(dataObject));
    }

    function updateDataObject(checkbox) {
      const formattedTime = checkbox.value;

      if (checkbox.checked) {
        if (!dataObject.includes(formattedTime)) {
          dataObject.push(formattedTime);
        }
      } else {
        const index = dataObject.indexOf(formattedTime);
        if (index !== -1) {
          dataObject.splice(index, 1);
        }
      }

      saveDataToLocalStorage();
    }

    function restoreCheckboxState() {
      const inputs = document.querySelectorAll('input[type="checkbox"]');

      inputs.forEach((input) => {
        const formattedTime = input.value;

        if (dataObject.includes(formattedTime)) {
          input.checked = true;
        }
      });
    }

    function showValues() {
      const inputs = document.querySelectorAll('input[type="checkbox"]');

      inputs.forEach((input) => {
        input.addEventListener('change', function () {
          updateDataObject(this);
        });
      });
    }

    const saveButton = document.getElementById('send-btn');

    function showSuccessMessage() {
      setTimeout(() => {
        saveButton.classList.remove('is-loading');
        document.querySelector('.schedule__text-success').classList.add('is-visible');
      }, 1500);
      setTimeout(() => {
        document.querySelector('.schedule__text-success').classList.remove('is-visible');
      }, 3000);
    }

    saveButton.addEventListener('click', function () {
      saveButton.classList.add('is-loading');
      sendDataToBackend();
    });

    function sendDataToBackend() {
      const x = new Date();
      const currentTimeZoneOffsetInHours = String(x.getTimezoneOffset() / 60);

      const token = localStorage.getItem('token');

      const dataToSend = JSON.stringify({
        session_token: token,
        schedule: dataObject,
        timezone: currentTimeZoneOffsetInHours
      });

      fetch('https://www.speakyourmind.help:8000/doctor_schedule', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: dataToSend
      })
        .then(response => {
          // Проверка, если сервер вернул успешный ответ
          if (!response.ok) {
            throw new Error('Ошибка сети: ' + response.status);
          }
          return response.json();
        })
        .then(data => {
          console.log(data);
          console.log('Расписание обновлено');
          showSuccessMessage();
        })
        .catch(error => {
          console.error('Произошла ошибка:', error);
        });
    }

    window.addEventListener('load', function () {

      // Начать календарь
      const c = new Calendar("divCal");
      c.showcurr();
      updateCal();

      // переключение кнопок

      // Показать текущую неделю
      document.querySelector("#btn-1").addEventListener("click", function () {
        c.showcurr();
        updateCal();
        clearBtnClasses()
        this.classList.add('is-active');
      });

      // Показать 2 неделю
      document.querySelector("#btn-2").addEventListener("click", function () {
        c.showWeek2();
        updateCal();
        clearBtnClasses();
        this.classList.add('is-active');
      });

      // Показать 3 неделю
      document.querySelector("#btn-3").addEventListener("click", function () {
        c.showWeek3();
        updateCal();
        clearBtnClasses();
        this.classList.add('is-active');
      });

      // Показать 4 неделю
      document.querySelector("#btn-4").addEventListener("click", function () {
        c.showWeek4();
        updateCal();
        clearBtnClasses();
        this.classList.add('is-active');
      });

      loadDataFromBackend();
      showValues();
    });

  </script>

  <script src="js/vendor.min.js"></script>
  <script src="js/main.min.js"></script>
</body>

</html>
