<!DOCTYPE html>
<html lang="ru">

<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="Speak your mind">
  <title>Speak your mind</title>
  <link rel="icon" type="image/x-icon" href="./favicon.ico">
  <link rel="icon" type="image/png" sizes="32x32" href="./img/favicon/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="./img/favicon/favicon-16x16.png">
  <link rel="apple-touch-icon" sizes="180x180" href="./img/favicon/apple-touch-icon.png">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/swiper@10/swiper-bundle.min.css">
  <link rel="stylesheet" href="css/style.min.css">
</head>

<body>
  <div class="wrapper">
    <header class="header">
      <div class="container">
        <div class="header__logo">
          <div class="header__logo-wrapper">
            <svg width="196" height="24" fill="currentColor">
              <use xlink:href="./img/sprite.svg#logo"></use>
            </svg>
          </div>
        </div>
        <nav class="header__nav nav">
          <div class="nav__wrapper">
            <ul class="nav__list">
              <li class="nav__item nav__item--psychologists">
                <a class="nav__link" data-translate="nav_doc" href="doctor-landing.html"></a>
              </li>
              <!-- <li class="nav__item nav__item--businnes">
                <a class="nav__link href="businnes-landing.html" data-translate="nav_comp"></a>
              </li> -->
              <li class="nav__item">
                <a class="nav__link" href="faq.html">FAQ</a>
              </li>
            </ul>
          </div>
        </nav>
        <div class="header__lang-switcher lang-switcher">
          <button class="lang-switcher__btn js-dropdown-trigger" data-id="#lang-switcher">
            <span class="current-language"></span>
            <svg width="10" height="10" fill="currentColor">
              <use xlink:href="./img/sprite.svg#dropdown"></use>
            </svg>
          </button>
          <ul class="lang-switcher__list list-reset" id="lang-switcher">
            <!-- <li class="lang-switcher__item">
              <a href="#" data-lang="hu">Hu</a>
            </li> -->
            <li class="lang-switcher__item">
              <a href="#" data-lang="en">En</a>
            </li>
            <li class="lang-switcher__item">
              <a href="#" data-lang="ru">Ru</a>
            </li>
          </ul>
        </div>
        <div class="header__unlogged unlogged">
          <a class="unlogged__login-btn btn btn--white" data-translate="header_login_btn"></a>
          <a href="user-signup-start.html" class="unlogged__login-btn btn" data-translate="header_signup_btn"></a>
        </div>
        <div class="header__logged logged">
          <div class="logged__wrapper">
            <div class="logged__user-thumb">
              <img src="./img/content/user-thumb.png" width="24" height="24" alt="">
            </div>
            <button class="logged__btn" id="#logged-menu">
              <span class="logged__username gotten-username">Username</span>
            </button>
          </div>
        </div>
      </div>
    </header>
    <main class="signup-main">
      <div class="signup-header">
        <div class="container">
          <div class="signup-header__links">
            <a class="signup-header__link" href="user-signup-main.html" data-translate="signup_header_link_main">Общие
              вопросы</a>
            <a class="signup-header__link is-active" href="#" data-translate="signup_header_link_choice">Выбор
              терапевта</a>
            <a class="signup-header__link" href="user-signup-payment.html"
              data-translate="signup_header_link_payment">Оплата</a>
          </div>
        </div>
      </div>
      <section class="choice">
        <div class="container">
          <div class="choice__wrapper">
            <div class="choice__heading">
              <h2 data-translate="choice_heading">Лучшие совпадения</h2>
            </div>
            <div class="choice__swiper swiper" id="swiper-1">
              <ul class="choice__list choice__thumbs-list list-reset swiper-wrapper">
                <!-- <li class="choice__item swiper-slide" id="1">
                  <div class="choice__item-image">
                    <img src="./img/temp/doc-1.png" width="100" height="100" alt="">
                  </div>
                  <p class="choice__item-name">Ирина</p>
                  <p class="choice__item-exp"><span>13 лет</span> опыта</p>
                </li>
                <li class="choice__item swiper-slide" id="2">
                  <div class="choice__item-image">
                    <img src="./img/temp/doc-2.png" width="100" height="100" alt="">
                  </div>
                  <p class="choice__item-name">Анатолий</p>
                  <p class="choice__item-exp"><span>6 лет</span> опыта</p>
                </li> -->
              </ul>
              <button type="button" class="swiper-btn swiper-btn--prev" aria-label="Previous slide.">
                <svg width="30" height="64" fill="currentColor">
                  <use xlink:href="./img/sprite.svg#swiper-arrow"></use>
                </svg>
              </button>
              <button type="button" class="swiper-btn swiper-btn--next" aria-label="Next slide.">
                <svg width="30" height="64" fill="currentColor">
                  <use xlink:href="./img/sprite.svg#swiper-arrow"></use>
                </svg>
              </button>
            </div>
            <div class="choice__doctors">
              <ul class="choices__doctors-list list-reset">
                <li class="choices__doctors-item doctor">
                  <div class="doctor__image">
                    <img src="./img/content/doctor-thumb.png" width="300" height="300" alt="">
                  </div>
                  <div class="doctor__content">
                    <div class="doctor__heading">
                      <p class="doctor__name"></p>
                      <p class="doctor__experience"><span data-translate="doctor__experience">Опыт</span> <span
                          class="doctor__experience-num">24 года</span></p>
                      <p class="doctor__details">
                        <span class="doctor__type">Индивидуальная сессия</span>
                        <span class="divider">&#8226;</span>
                        <span class="doctor__time">50 <span data-translate="doctor_time_min">мин</span></span>
                        <span class="divider">&#8226;</span>
                        <span class="doctor__price">10&nbsp;000 HUF</span>
                      </p>
                      <p class="doctor__themes" data-translate="doctor_themes">Работает со всеми темами вашей анкеты</p>
                      <a href="#schedule" class="doctor__btn doctor__schedule-btn btn"
                        data-translate="doctor_schedule_btn">Выбрать время сессии</a>
                    </div>
                    <div class="doctor__content-block" id="about-doctor">
                      <h2 class="text-25 doctor__title" data-translate="about_doctor">О специалисте</h2>
                      <p class="text-18 about-doctor-text"></p>
                    </div>
                    <div class="doctor__content-block" id="doctor__edu">
                      <h2 class="text-25 doctor__title" data-translate="doc_q_edu_placeholder">Образование</h2>
                      <ul class="settings__edu-list doctor__edu-list list-reset"></ul>
                    </div>
                    <div class="doctor__content-block" id="schedule">
                      <h2 class="text-25 doctor__title" data-translate="doctor_schedule_title">Расписание</h2>
                      <p class="text-18" data-translate="doctor_schedule_subtitle">Выберите дату и время</p>
                      <br>
                      <form class="choice-date-form schedule-wrapper" action="" method="post" id="choice-date-form">
                        <div class="schedule-container"></div>

                        <button type="button" class="schedule__show-more">
                          <span data-translate="schedule_show_more">Показать еще 3 дня</span>
                          <svg width="10" height="10" fill="currentColor">
                            <use xlink:href="./img/sprite.svg#dropdown-green"></use>
                          </svg>
                        </button>

                        <button type="submit" disabled class="doctor__submit-btn btn">
                          <span class="doctor__submit-text" data-translate="doctor_submit_btn_1">Выбрать</span>&nbsp;
                          <span class="doctor__submit-date"></span>&nbsp;
                          <span class="doctor__submit-text-2" data-translate="doctor_submit_btn_2">и продолжить</span>
                        </button>
                        <span class="error-message" data-translate="doctor_submit_err">Пожалуйста, выберите дату</span>
                      </form>
                    </div>
                  </div>
                </li>
              </ul>
            </div>
          </div>
        </div>
      </section>
    </main>
    <footer class="footer">
      <div class="container">
        <div class="footer__left"></div>
        <div class="footer__copyright">
          <span>&copy; Speak Your Mind 2023</span>
          <a href="terms.html" class="text-green" data-translate="terms">Условия предоставления услуг</a>
        </div>
      </div>
    </footer>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', function () {
      // получение данных клиента
      const session_token = localStorage.getItem('token');
      const submitBtn = document.querySelector('.doctor__submit-btn');
      const language = localStorage.getItem('language') || 'en';

      function getUserDataFromBackend() {
        if (session_token) {
          fetch('http://127.0.0.1:8000/get_client_data', {
            method: 'POST',
            headers: {
              'Authorization': `Bearer ${session_token}`,
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({ session_token: session_token })
          })
            .then(response => {
              if (!response.ok) {
                throw new Error('Сеть не в порядке');
              }
              return response.json();
            })
            .then(data => {
              // TODO удалить вывод в консоль
              console.log('Данные пользователя:', data);
              getTherapistList();
            })
            .catch(error => {
              console.error('Ошибка при получении данных пользователя:', error);
            });
        } else {
          console.log('Токен не найден. Пожалуйста, войдите в систему.');
        }
      }

      getUserDataFromBackend();

      // загрузка списка терапевтов

      function getTherapistList() {
        fetch('http://127.0.0.1:8000/get_therapist_list', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ session_token: session_token })
        })
          .then(response => {
            if (!response.ok) {
              throw new Error('Сеть не в порядке');
            }
            return response.json();
          })
          .then(data => {
            renderTherapistList(data.list_of_doctors);
          })
          .catch(error => {
            console.error('Ошибка при получении данных пользователя:', error);
          });
      }

      function renderTherapistList(data) {
        console.log(data);

        const slider = document.querySelector('.choice__list');
        const doctorImageElement = document.querySelector('.doctor__image img');
        const doctorNameElement = document.querySelector('.doctor__name');
        const doctorExpElement = document.querySelector('.doctor__experience-num');
        const doctorTypeElement = document.querySelector('.doctor__type');
        const doctorPriceElement = document.querySelector('.doctor__price');
        const aboutDoctorTextElement = document.querySelector('.about-doctor-text');
        const eduListElement = document.querySelector('.settings__edu-list');
        const scheduleContainer = document.querySelector('.schedule-container');

        const translationsExp = {
          ru: {
            experience: 'Опыт:',
            years: 'л',
          },
          en: {
            experience: 'Experience:',
            years: 'y'
          }
        };

        const therapyTranslations = {
          ru: {
            0: 'Индивидуальная сессия',
            1: 'Парная сессия',
            2: 'Индивидуальная и парная сессия'
          },
          en: {
            0: 'Individual session',
            1: 'Couples session',
            2: 'Individual and couples session',
          }
        };

        const therapyPrice = {
          0: '19 500 HUF',
          1: '29 500 HUF',
          2: '39 500 HUF'
        };

        const experienceText = translationsExp[language].experience;
        const yearsText = translationsExp[language].years;

        data.forEach((doc) => {
          const listItem = document.createElement('li');
          listItem.className = 'choice__item swiper-slide';

          const image = document.createElement('div');
          image.classList = 'choice__item-image';

          const img = document.createElement('img');
          img.setAttribute('width', '100');
          img.setAttribute('height', '100');
          img.setAttribute('alt', `${doc.doc_name}`);
          if (doc.user_photo && doc.user_photo !== null) {
            img.src = doc.user_photo;
          } else {
            img.src = "./img/content/doctor-thumb.png";
          }
          image.appendChild(img);
          listItem.appendChild(image);

          listItem.innerHTML += `
                <p class="choice__item-name">${doc.doc_name}</p>
                <p class="choice__item-exp">${calculateExperience(doc.doc_practice_start, language)}</p>
            `;

          slider.appendChild(listItem);

          listItem.addEventListener('click', () => {
            // аватар
            if (doc.user_photo && doc.user_photo !== null) {
              doctorImageElement.src = doc.user_photo;
            } else {
              doctorImageElement.src = "./img/content/doctor-thumb.png";
            }
            // имя
            doctorNameElement.textContent = doc.doc_name;

            // опыт
            doctorExpElement.textContent = calculateExperience(doc.doc_practice_start, language);

            // тип сессии
            doctorTypeElement.textContent = therapyTranslations[language][doc.doc_therapy_type];

            // цена
            doctorPriceElement.textContent = therapyPrice[doc.doc_session_cost];

            // о специалисте
            aboutDoctorTextElement.textContent = doc.doc_additional_info;

            // Очищаем предыдущие данные об образовании
            eduListElement.innerHTML = '';

            // Очищаем предыдущие данные о расписании
            scheduleContainer.innerHTML = '';

            // Рендерим информацию об образовании
            renderEducation(doc.doc_edu);

            // Рендерим расписание
            renderSchedule(doc.doc_schedule);

            // сохраняем айди доктора в LS
            localStorage.setItem('selected_therapist', doc.doc_id);
            localStorage.setItem('selected_therapist_name', doc.doc_name);
          });
        });

        document.querySelectorAll('.choice__item')[0].click();

        function calculateExperience(data, language) {
          const [month, year] = data.split(' ').map(Number);
          const practiceStartDate = new Date(year, month - 1);
          const currentDate = new Date();
          const differenceInMilliseconds = currentDate - practiceStartDate;
          const differenceInYears = Math.floor(differenceInMilliseconds / (1000 * 60 * 60 * 24 * 365.25));
          const sliceYear = String(differenceInYears).slice(-1);
          let experienceText;
          if (language === 'ru') {
            if (parseInt(sliceYear, 10) === 1 && (parseInt(sliceYear, 10) < 10 || parseInt(sliceYear, 10) > 20)) {
              experienceText = `${differenceInYears} год`;
            } else if ((parseInt(sliceYear, 10) === 2 || parseInt(sliceYear, 10) === 3 || parseInt(sliceYear, 10) === 4) && (parseInt(differenceInYears, 10) < 10 || parseInt(differenceInYears, 10) > 20)) {
              experienceText = `${differenceInYears} года`;
            } else {
              experienceText = `${differenceInYears} лет`;
            }
          } else if (language === 'en') {
            if (parseInt(sliceYear, 10) === 1 && (parseInt(differenceInYears, 10) < 10 || parseInt(differenceInYears, 10) > 20)) {
              experienceText = `${differenceInYears} year`;
            } else {
              experienceText = `${differenceInYears} years`;
            }
          }

          return experienceText;
        }

        function renderEducation(eduData) {
          // Проверяем, есть ли данные об образовании
          if (eduData.length === 0) {
            const noEducationItem = document.createElement('li');
            noEducationItem.textContent = 'Нет информации об образовании';
            eduListElement.appendChild(noEducationItem);
            return;
          }

          eduData.forEach((el) => {
            const wrapper = document.createElement('li');
            wrapper.className = 'settings__edu-item';

            const year = document.createElement('p');
            year.className = 'settings__edu-field settings__edu-field--year';
            year.textContent = el.year;

            const university = document.createElement('p');
            university.className = 'settings__edu-field settings__edu-field--university';
            university.textContent = el.university;

            const faculty = document.createElement('p');
            faculty.className = 'settings__edu-field settings__edu-field--faculty';
            faculty.textContent = el.faculty;

            const degree = document.createElement('p');
            degree.className = 'settings__edu-field settings__edu-field--degree';
            degree.textContent = el.degree;

            wrapper.appendChild(year);
            wrapper.appendChild(university);
            wrapper.appendChild(faculty);
            wrapper.appendChild(degree);
            eduListElement.appendChild(wrapper);
          });
        }

        function renderSchedule(scheduleData) {
          // Группируем расписание по датам
          const scheduleByDate = {};
          const now = new Date().getTime(); // Получаем текущее время

          scheduleData.forEach((item) => {
            const date = new Date(item.time);
            const scheduledTime = new Date(item.time).getTime();
            const dateString = date.toISOString().split('T')[0]; // Получаем строку формата YYYY-MM-DD
            const timeString = date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }); // Форматируем время

            // Проверяем, прошло ли время
            if (scheduledTime > now) { // Если время в будущем
              if (!scheduleByDate[dateString]) {
                scheduleByDate[dateString] = [];
              }
              scheduleByDate[dateString].push({ timeString, sh_id: item.sh_id }); // Сохраняем время и sh_id
            }
          });

          // Создаем элементы для каждой даты и времени
          for (const [date, times] of Object.entries(scheduleByDate)) {
            // Сортируем временные слоты по времени
            times.sort((a, b) => {
              const timeA = new Date(`${date}T${a.timeString}`);
              const timeB = new Date(`${date}T${b.timeString}`);
              return timeA - timeB; // Сравниваем по времени
            });

            const dayWrapper = document.createElement('div');
            dayWrapper.className = 'doctor__day-wrapper';

            const dayElement = document.createElement('p');
            dayElement.className = 'doctor__day';

            const language = localStorage.getItem('language') || 'en';
            const dateObj = new Date(date);

            if (language === 'en') {
              dayElement.innerHTML = `<time datetime="${date}">${dateObj.getDate()} ${dateObj.toLocaleString('en-US', { month: 'long' })}</time>`;
            } else {
              dayElement.innerHTML = `<time datetime="${date}">${dateObj.getDate()} ${dateObj.toLocaleString('ru-RU', { month: 'long' })}</time><span>, ${dateObj.toLocaleString('ru-RU', { weekday: 'long' })}</span>`;
            }
            const fieldset = document.createElement('fieldset');
            times.forEach(({ timeString, sh_id }) => {
              const label = document.createElement('label');
              const input = document.createElement('input');
              input.type = 'radio';
              input.name = 'appointment-time';
              input.value = timeString; // Сохраняем время в качестве значения
              input.setAttribute('data-id', sh_id); // Добавляем data-id
              input.setAttribute('data-time', date); // Добавляем data-time

              const timeValue = document.createElement('span');
              timeValue.className = 'time-value';
              timeValue.textContent = timeString;

              label.appendChild(input);
              label.appendChild(timeValue);
              fieldset.appendChild(label);

              input.addEventListener('change', () => {
                submitBtn.classList.add('is-enabled');
                submitBtn.setAttribute('sh_id', sh_id);
                // TODO переписать в удобный формат
                submitBtn.querySelector('.doctor__submit-date').textContent = `${timeString} ${date}`;
                submitBtn.querySelector('.doctor__submit-text-2').style.display = 'inline';
                submitBtn.disabled = false;
                localStorage.setItem('session_datetime', `${timeString} ${date}`)
              });
            });

            // Если есть доступные временные слоты, добавляем их в расписание
            if (times.length > 0) {
              dayWrapper.appendChild(dayElement);
              dayWrapper.appendChild(fieldset);
              scheduleContainer.appendChild(dayWrapper);
            }
          }
        }
      }

      // отправка выбора терапевта и даты сессии
      document.getElementById('choice-date-form').addEventListener('submit', function (e) {
        e.preventDefault();
        const doc_id = Number(localStorage.getItem('selected_therapist'));
        const sh_id = Number(submitBtn.getAttribute('sh_id'));

        const dataToSend = {
          session_token: session_token,
          doc_id: doc_id,
          sh_id: sh_id
        };

        console.log(dataToSend);

        fetch('http://127.0.0.1:8000/select_slot', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(dataToSend)
        })
          .then(response => {
            if (!response.ok) {
              throw new Error('Сеть не в порядке');
            }
            return response.json();
          })
          .then(data => {
            console.log('Данные пользователя обновлены');
            console.log(data);
            localStorage.setItem('has_therapist', 'selected');
            // TODO тут будет проверка на привязку карты и если карта не привязана - редирект на оплату
            window.location.href = '/user-signup-payment.html'
          })
          .catch(error => {
            console.error('Ошибка при получении данных пользователя:', error);
          });
      });
    });
  </script>

  <script src="js/vendor.min.js"></script>
  <script src="js/main.min.js"></script>
</body>

</html>
